name: Deploy Backend to EC2

on:
  push:
    branches: [main]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          docker build \
            -t kc-ai-backend:latest \
            -f ./backend/Dockerfile ./backend

      - name: Save Docker Image
        run: |
          docker save kc-ai-backend:latest | gzip > backend.tar.gz

      - name: Copy Image to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend.tar.gz"
          target: "/opt/kc-ai/"

      - name: Deploy on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            echo "Starting kc-ai backend deployment..."

            APP_DIR="/opt/kc-ai"
            ENV_FILE="/opt/kc-ai/.env.production"

            mkdir -p $APP_DIR

            echo "Loading Docker image from tar..."
            gunzip -c $APP_DIR/backend.tar.gz | sudo docker load

            echo "Stopping kc-ai_backend container..."
            sudo docker stop kc-ai_backend || true
            sudo docker rm kc-ai_backend || true

            echo "Starting kc-aibackend container on port 3001..."
            sudo docker run -d \
              --name kc-ai_backend \
              -p 3001:3001 \
              --restart unless-stopped \
              --env-file $ENV_FILE \
              kc-ai-backend:latest

            echo "Verifying deployment..."
            sudo docker ps | grep kc-ai_backend

            echo "kc-ai backend deployed successfully"
